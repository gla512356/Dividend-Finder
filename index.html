import streamlit as st
import yfinance as yf
import pandas as pd
from datetime import datetime, time
import pytz
import math

# ---------------------------------------------------------
# [ì„¤ì •] ì•± ê¸°ë³¸ ì„¤ì •
# ---------------------------------------------------------
st.set_page_config(
    page_title="YieldMax Pro - Group 2",
    page_icon="ğŸ’",
    layout="centered",
    initial_sidebar_state="collapsed"
)

# ---------------------------------------------------------
# [í•µì‹¬] HTML ê³µë°± ì œê±° í•¨ìˆ˜
# ---------------------------------------------------------
def render_html(raw_html):
    cleaned = " ".join([line.strip() for line in raw_html.splitlines() if line.strip()])
    st.markdown(cleaned, unsafe_allow_html=True)

# ---------------------------------------------------------
# [ìŠ¤íƒ€ì¼] CSS (í”„ë¦¬ë¯¸ì—„ UI/UX + íƒ­ ìµœì í™”)
# ---------------------------------------------------------
render_html("""
    <style>
    @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
    
    /* 1. ê¸°ë³¸ ì„¸íŒ… */
    html, body, [class*="css"] {
        font-family: 'Pretendard', sans-serif;
        background-color: #f4f6f8;
        color: #1b1e26;
    }
    
    /* 2. í—¤ë” ì¹´ë“œ */
    .header-card {
        background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
        padding: 32px 24px;
        border-radius: 28px;
        color: white;
        margin-bottom: 24px;
        box-shadow: 0 15px 35px rgba(15, 32, 39, 0.25);
        position: relative;
        overflow: hidden;
    }
    .header-card::after {
        content: ''; position: absolute; top: -50%; right: -20%;
        width: 300px; height: 300px;
        background: radial-gradient(circle, rgba(255,255,255,0.08) 0%, transparent 70%);
        border-radius: 50%;
        pointer-events: none;
    }

    /* í™˜ìœ¨ ë°°ì§€ */
    .fx-badge {
        background: rgba(255, 255, 255, 0.1);
        padding: 6px 12px;
        border-radius: 12px;
        font-size: 0.8rem; font-weight: 500;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.15);
        display: inline-flex; align-items: center; gap: 6px;
        margin-bottom: 8px;
    }

    /* ë§ˆì¼“ ìƒíƒœ ë°°ì§€ */
    .market-badge {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 700;
        margin-bottom: 10px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    
    .status-open { background-color: #00e676; color: #003300; animation: pulse 2s infinite; }
    .status-pre { background-color: #ffea00; color: #3e2723; }
    .status-after { background-color: #d1c4e9; color: #4527a0; }
    .status-closed { background-color: #cfd8dc; color: #455a64; }

    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(0, 230, 118, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(0, 230, 118, 0); }
        100% { box-shadow: 0 0 0 0 rgba(0, 230, 118, 0); }
    }

    /* 3. íƒ€ì„ë¼ì¸ */
    .timeline-container { display: flex; gap: 10px; margin-top: 28px; }
    .glass-box {
        flex: 1; text-align: center;
        background: rgba(255,255,255,0.08);
        padding: 12px; border-radius: 18px;
        border: 1px solid rgba(255,255,255,0.1);
        backdrop-filter: blur(5px);
    }
    .t-label { font-size: 0.75rem; color: rgba(255,255,255,0.7); margin-bottom: 4px; }
    .t-val { font-size: 0.95rem; font-weight: 700; color: #fff; }
    .accent-gold { color: #ffd700; }
    
    /* 4. ì •ë³´ ì¹´ë“œ */
    .info-card { background: white; border-radius: 24px; padding: 28px 24px; box-shadow: 0 8px 20px rgba(0,0,0,0.04); border: 1px solid #ffffff; margin-bottom: 20px; }
    
    /* 5. ë©”íŠ¸ë¦­ ê·¸ë¦¬ë“œ */
    .metric-container { display: flex; gap: 12px; margin-top: 24px; }
    .metric-box { flex: 1; background: #f9fafb; border-radius: 16px; padding: 16px 8px; text-align: center; border: 1px solid #edf0f5; transition: all 0.2s; }
    .metric-box:hover { background: #f0f4ff; border-color: #dbe4ff; transform: translateY(-2px); }
    .m-title { font-size: 0.7rem; color: #8b95a1; font-weight: 600; margin-bottom: 6px; }
    .m-data { font-size: 1rem; font-weight: 800; color: #333; }
    
    /* 6. ê°ì¢… ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .calc-box { background: #f8f9fa; border-radius: 20px; padding: 24px; margin-top: 10px; border: 1px solid #edf0f5; }
    .fire-card { background: linear-gradient(135deg, #fff 0%, #f3f6ff 100%); border: 1px solid #dcebfb; border-radius: 24px; padding: 24px; margin-top: 10px; box-shadow: 0 4px 12px rgba(49, 130, 246, 0.08); text-align: center; }
    .bep-card { background: linear-gradient(135deg, #fff 0%, #fff8f8 100%); border: 1px solid #ffebee; border-radius: 24px; padding: 24px; margin-top: 10px; box-shadow: 0 4px 12px rgba(233, 44, 44, 0.05); text-align: center; }
    .snow-card { background: linear-gradient(135deg, #e3f2fd 0%, #f1f8ff 100%); border: 1px solid #bbdefb; border-radius: 24px; padding: 24px; margin-top: 10px; box-shadow: 0 4px 12px rgba(33, 150, 243, 0.1); text-align: center; }
    .stress-card { background: #fff; border: 1px solid #eee; border-radius: 20px; padding: 20px; margin-top: 10px; }
    .mul-card { background: #fff; border: 1px solid #e0e0e0; border-radius: 20px; padding: 20px; margin-top: 10px; }

    /* ìœ í‹¸ë¦¬í‹° */
    .result-row { display: flex; justify-content: space-between; margin-bottom: 12px; align-items: center; }
    .result-label { font-size: 0.9rem; color: #6b7684; }
    .result-val { font-weight: 700; color: #333; }
    .result-total { font-size: 1.5rem; font-weight: 800; color: #3182f6; }
    .mul-arrow { font-size: 1.2rem; color: #bbb; margin: 0 8px; }
    .mul-highlight { color: #3182f6; font-weight: 800; }
    .stress-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f5f5f5; }
    .stress-row:last-child { border-bottom: none; }
    .stress-label { font-size: 0.9rem; color: #666; font-weight: 600; }
    .stress-val { font-size: 1rem; font-weight: 700; color: #333; }
    .stress-badge { font-size: 0.75rem; padding: 3px 8px; border-radius: 6px; background: #eee; color: #666; margin-right: 8px; }
    
    .caution-box { margin-top: 15px; padding: 14px; background: #fafafa; border-radius: 12px; border: 1px dashed #d1d6db; text-align: left; font-size: 0.8rem; color: #666; line-height: 1.6; }
    .caution-title { font-weight: 700; color: #4e5968; margin-bottom: 4px; display: block; }

    /* ë±ƒì§€ */
    .ticker-tag { background: #e8f3ff; color: #3182f6; padding: 4px 10px; border-radius: 8px; font-weight: 800; font-size: 0.9rem; }
    .risk-badge-high { background: #fff0f2; color: #e92c2c; padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; }
    .risk-badge-low { background: #e3fcf2; color: #00bfa5; padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; }

    /* ë²„íŠ¼ & íƒ­ */
    div.stButton > button { width: 100%; border-radius: 12px; font-weight: 700; background-color: #ffffff; border: 1px solid #e5e8eb; color: #4e5968; padding: 0.5rem 1rem; transition: all 0.2s; }
    div.stButton > button:hover { background-color: #f2f4f6; color: #191f28; border-color: #c5cdd6; }
    
    /* íƒ­ ë©”ë‰´ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ê²Œ (ëª¨ë°”ì¼ ëŒ€ì‘) */
    .stTabs [data-baseweb="tab-list"] { gap: 8px; overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; padding-bottom: 4px; }
    .stTabs [data-baseweb="tab"] { height: 46px; background-color: #fff; border-radius: 10px; border: 1px solid #eee; gap: 0; padding: 0 14px; font-size: 0.85rem; flex-shrink: 0; }
    .stTabs [aria-selected="true"] { background-color: #eef4ff; border-color: #3182f6; color: #3182f6; font-weight: 700; }
    </style>
""")

# ---------------------------------------------------------
# [ë°ì´í„°] Group 2 ë°°ë‹¹ ë°ì´í„° (2026-01-02 ë°°ë‹¹ë½)
# ---------------------------------------------------------
# ë°°ë‹¹ë½: 2026-01-02 (ê¸ˆ)
# 1/1(ëª©) íœ´ì¥ì´ë¯€ë¡œ, 12/31(ìˆ˜) ì¥ë§ˆê°ê¹Œì§€ ë§¤ìˆ˜ í•„ìš”
SCHEDULE_KST = {
    "buy_limit": "1/1(ëª©) 06:00", # í•œêµ­ì‹œê°„ ê¸°ì¤€ (12/31 NY ë§ˆê°)
    "ex_date": "1/2(ê¸ˆ)",
    "pay_date": "1/5(ì›”)"
}

DATA_MAP = {
    'ABNY': {'div': 0.3313, 'rate': 36.12, 'sec': 2.92, 'roc': 0.00, 'name': 'ABNB Option Strategy'},
    'AIYY': {'div': 0.1725, 'rate': 50.71, 'sec': 3.08, 'roc': 0.00, 'name': 'AI Option Strategy'},
    'AMDY': {'div': 0.3796, 'rate': 51.64, 'sec': 1.15, 'roc': 95.55, 'name': 'AMD Option Strategy'},
    'AMZY': {'div': 0.0651, 'rate': 25.34, 'sec': 2.97, 'roc': 89.57, 'name': 'AMZN Option Strategy'},
    'APLY': {'div': 0.0532, 'rate': 20.69, 'sec': 2.32, 'roc': 89.19, 'name': 'AAPL Option Strategy'},
    'BABO': {'div': 0.0915, 'rate': 35.90, 'sec': 2.37, 'roc': 91.54, 'name': 'BABA Option Strategy'},
    'BRKC': {'div': 0.1368, 'rate': 15.71, 'sec': 2.55, 'roc': 11.88, 'name': 'BRKB Option Strategy'},
    'CONY': {'div': 0.4342, 'rate': 56.15, 'sec': 3.91, 'roc': 41.34, 'name': 'COIN Option Strategy'},
    'CRCO': {'div': 0.4012, 'rate': 85.68, 'sec': 4.59, 'roc': 95.86, 'name': 'CRCL Option Strategy'},
    'CRSH': {'div': 0.2406, 'rate': 48.88, 'sec': 2.60, 'roc': 0.00, 'name': 'Short TSLA Strategy'},
    'CVNY': {'div': 0.3320, 'rate': 45.83, 'sec': 2.51, 'roc': 4.85, 'name': 'CVNA Option Strategy'},
    'DIPS': {'div': 0.3945, 'rate': 40.07, 'sec': 2.75, 'roc': 87.54, 'name': 'Short NVDA Strategy'},
    'DISO': {'div': 0.0899, 'rate': 38.28, 'sec': 3.41, 'roc': 58.43, 'name': 'DIS Option Strategy'},
    'DRAY': {'div': 0.3011, 'rate': 50.23, 'sec': 2.84, 'roc': 42.06, 'name': 'DKNG Option Strategy'},
    'FBY': {'div': 0.0612, 'rate': 25.03, 'sec': 2.97, 'roc': 0.00, 'name': 'META Option Strategy'},
    'FIAT': {'div': 0.4126, 'rate': 77.71, 'sec': 2.63, 'roc': 97.58, 'name': 'Short COIN Strategy'},
    'GDXY': {'div': 0.1593, 'rate': 51.24, 'sec': 2.64, 'roc': 95.40, 'name': 'Gold Miners Strategy'},
    'GMEY': {'div': 0.3829, 'rate': 55.11, 'sec': 2.90, 'roc': 5.78, 'name': 'GME Option Strategy'},
    'GOOY': {'div': 0.0846, 'rate': 30.01, 'sec': 2.37, 'roc': 91.70, 'name': 'GOOGL Option Strategy'},
    'HIYY': {'div': 0.3145, 'rate': 65.42, 'sec': 4.00, 'roc': 25.20, 'name': 'HIMS Option Strategy'},
    'HOOY': {'div': 0.5728, 'rate': 61.44, 'sec': 1.68, 'roc': 26.92, 'name': 'HOOD Option Strategy'},
    'JPMO': {'div': 0.0812, 'rate': 26.38, 'sec': 1.96, 'roc': 92.54, 'name': 'JPM Option Strategy'},
    'MARO': {'div': 0.1285, 'rate': 85.29, 'sec': 4.66, 'roc': 92.54, 'name': 'MARA Option Strategy'},
    'MRNY': {'div': 0.1601, 'rate': 55.18, 'sec': 2.85, 'roc': 0.00, 'name': 'MRNA Option Strategy'},
    'MSFO': {'div': 0.0620, 'rate': 20.75, 'sec': 3.05, 'roc': 85.48, 'name': 'MSFT Option Strategy'},
    'MSTY': {'div': 0.4091, 'rate': 70.36, 'sec': 2.73, 'roc': 94.34, 'name': 'MSTR Option Strategy'},
    'NFLY': {'div': 0.0729, 'rate': 31.54, 'sec': 3.21, 'roc': 87.18, 'name': 'NFLX Option Strategy'},
    'NVDY': {'div': 0.1435, 'rate': 50.87, 'sec': 2.58, 'roc': 94.92, 'name': 'NVDA Option Strategy'},
    'OARK': {'div': 0.2191, 'rate': 30.88, 'sec': 2.76, 'roc': 0.00, 'name': 'Innovation Strategy'},
    'PLTY': {'div': 0.5130, 'rate': 50.78, 'sec': 3.06, 'roc': 94.88, 'name': 'PLTR Option Strategy'},
    'PYPY': {'div': 0.2833, 'rate': 35.61, 'sec': 3.73, 'roc': 97.61, 'name': 'PYPL Option Strategy'},
    'RBLY': {'div': 0.2572, 'rate': 45.49, 'sec': 3.92, 'roc': 0.00, 'name': 'RBLX Option Strategy'},
    'RDYY': {'div': 0.4836, 'rate': 65.98, 'sec': 2.81, 'roc': 0.00, 'name': 'RDDT Option Strategy'},
    'SMCY': {'div': 0.0947, 'rate': 60.07, 'sec': 3.90, 'roc': 19.12, 'name': 'SMCI Option Strategy'},
    'SNOY': {'div': 0.1081, 'rate': 45.38, 'sec': 2.51, 'roc': 37.95, 'name': 'SNOW Option Strategy'},
    'TSLY': {'div': 0.3658, 'rate': 50.21, 'sec': 2.77, 'roc': 0.00, 'name': 'TSLA Option Strategy'},
    'TSMY': {'div': 0.0906, 'rate': 30.59, 'sec': 2.45, 'roc': 91.35, 'name': 'TSM Option Strategy'},
    'WNTR': {'div': 0.6812, 'rate': 90.88, 'sec': 1.56, 'roc': 83.32, 'name': 'Short MSTR Strategy'},
    'XOMO': {'div': 0.0456, 'rate': 20.20, 'sec': 3.28, 'roc': 86.47, 'name': 'XOM Option Strategy'},
    'XYZY': {'div': 0.3337, 'rate': 50.75, 'sec': 3.60, 'roc': 29.32, 'name': 'XYZ Option Strategy'},
    'YBIT': {'div': 0.2846, 'rate': 43.73, 'sec': 2.45, 'roc': 92.66, 'name': 'Bitcoin Option Strategy'},
    'YQQQ': {'div': 0.0423, 'rate': 18.18, 'sec': 2.77, 'roc': 0.00, 'name': 'Short N100 Strategy'},
}

# -----------------------------
# [í•¨ìˆ˜] ë§ˆì¼“ ìƒíƒœ ì²´í¬
# -----------------------------
def get_us_market_status():
    ny_tz = pytz.timezone('America/New_York')
    now_ny = datetime.now(ny_tz)

    if now_ny.weekday() >= 5: 
        return "â›” íœ´ì¥ (ì£¼ë§)", "status-closed"

    holidays_2025 = [
        "2025-01-01", "2025-01-20", "2025-02-17", "2025-04-18", 
        "2025-05-26", "2025-06-19", "2025-07-04", "2025-09-01", 
        "2025-11-27", "2025-12-25"
    ]
    if now_ny.strftime("%Y-%m-%d") in holidays_2025:
        return "â›” íœ´ì¥ (ê³µíœ´ì¼)", "status-closed"

    minutes = now_ny.hour * 60 + now_ny.minute
    if 240 <= minutes < 570:
        return "ğŸŒ… í”„ë¦¬ë§ˆì¼“ ì§„í–‰ ì¤‘", "status-pre"
    elif 570 <= minutes < 960:
        return "ğŸ”¥ ì •ê·œì¥ ì˜¤í”ˆ (ì‹¤ì‹œê°„)", "status-open"
    elif 960 <= minutes < 1200:
        return "ğŸŒ™ ì• í”„í„°ë§ˆì¼“ ì§„í–‰ ì¤‘", "status-after"
    else:
        return "ğŸ’¤ ì¥ ë§ˆê° (íœ´ì¥)", "status-closed"

# -----------------------------
# [í•¨ìˆ˜] ë°ì´í„° ì—°ê²° (15ì´ˆ ê°±ì‹ )
# -----------------------------
@st.cache_data(ttl=15, show_spinner=False)
def get_market_info(ticker_keys):
    try:
        fx = yf.Ticker("USDKRW=X").history(period="1d")["Close"].iloc[-1]
    except:
        fx = 1430.0

    prices = {}
    try:
        t_str = " ".join(ticker_keys)
        data = yf.download(t_str, period="1d", progress=False)['Close']
        for t in ticker_keys:
            try:
                val = data[t].iloc[-1] if isinstance(data, pd.DataFrame) else data[t]
                prices[t] = float(val)
            except:
                prices[t] = 0.0
    except:
        pass

    now_time = datetime.now(pytz.timezone('Asia/Seoul')).strftime("%H:%M:%S")
    return fx, prices, now_time

# -----------------------------
# [ë¡œì§] ë°ì´í„° ë¡œë”©
# -----------------------------
if st.button("ğŸ”„ ì‹¤ì‹œê°„ ì‹œì„¸ ìƒˆë¡œê³ ì¹¨"):
    st.cache_data.clear()

with st.spinner("ë¯¸êµ­ í˜„ì§€ ë°ì´í„° ìˆ˜ì‹  ì¤‘..."):
    t_list = sorted(list(DATA_MAP.keys()))
    usd_krw, price_map, update_time = get_market_info(t_list)
    market_text, market_class = get_us_market_status()

tax_rate = 0.154

# -----------------------------
# [UI] 1. ë©”ì¸ í—¤ë”
# -----------------------------
render_html(f"""
    <div class="header-card">
        <div style="display:flex; justify-content:space-between; align-items:start;">
            <div>
                <span class="market-badge {market_class}">{market_text}</span>
                <h2 style="margin:0; font-size:1.6rem; font-weight:800; letter-spacing:-0.5px;">
                    YieldMax ê·¸ë£¹ 2<br>ìµœì‹  ë°°ë‹¹ ë‚´ì—­
                </h2>
            </div>
            <div style="text-align:right;">
                <div class="fx-badge">
                    1 USD = {usd_krw:,.2f}ì›
                </div>
                <div style="font-size:0.75rem; margin-top:4px; opacity:0.8;">
                    ê¸°ì¤€: {update_time} (KST)
                </div>
            </div>
        </div>

        <div class="timeline-container">
            <div class="glass-box">
                <div class="t-label">ğŸš¨ ë§¤ìˆ˜ë§ˆê°(í•œêµ­)</div>
                <div class="t-val accent-gold">{SCHEDULE_KST['buy_limit']}</div>
            </div>
            <div class="glass-box">
                <div class="t-label">ğŸ“‰ ë°°ë‹¹ë½ì¼</div>
                <div class="t-val">{SCHEDULE_KST['ex_date']}</div>
            </div>
            <div class="glass-box">
                <div class="t-label">ğŸ’° ì§€ê¸‰ì¼(ì˜ˆì •)</div>
                <div class="t-val" style="color:#69f0ae;">{SCHEDULE_KST['pay_date']}</div>
            </div>
        </div>
    </div>
""")

# -----------------------------
# [UI] 2. ìƒì„¸ ì •ë³´
# -----------------------------
st.markdown("### ğŸ’ ì¢…ëª©ë³„ ìƒì„¸ ë¶„ì„")

col_sel, _ = st.columns([1, 0.01])
with col_sel:
    def_idx = t_list.index("CONY") if "CONY" in t_list else 0
    sel_ticker = st.selectbox("ë¶„ì„í•  ETF ì„ íƒ", t_list, index=def_idx)

# ë°ì´í„°
d = DATA_MAP[sel_ticker]
curr_p = price_map.get(sel_ticker, 0.0)
div_krw = d['div'] * usd_krw
div_krw_net = div_krw * (1 - tax_rate)

if d['roc'] > 50:
    analysis_badge = "<span class='risk-badge-high'>ğŸ”¥ ì´ˆê³ ìœ„í—˜ ê³µê²©í˜•</span>"
elif d['roc'] > 0:
    analysis_badge = "<span class='risk-badge-high'>âš ï¸ ê³ ìˆ˜ìµ ì¶”êµ¬í˜•</span>"
else:
    analysis_badge = "<span class='risk-badge-low'>ğŸ›¡ï¸ ê±´ì „ ë°°ë‹¹í˜•</span>"

render_html(f"""
    <div class="info-card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <div style="display:flex; align-items:center; gap:12px;">
                <span class="ticker-tag">{sel_ticker}</span>
                {analysis_badge}
            </div>
            <span style="font-size:0.8rem; color:#888;">{d['name']}</span>
        </div>

        <div style="text-align:center; padding: 10px 0 20px 0;">
            <div style="font-size:0.9rem; color:#8b95a1; margin-bottom:6px;">1ì£¼ë‹¹ í™•ì • ë°°ë‹¹ê¸ˆ</div>
            <div style="font-size:2.6rem; font-weight:900; color:#191f28; letter-spacing:-1px; line-height:1;">
                ${d['div']:.4f}
            </div>
            <div style="font-size:1.1rem; font-weight:700; color:#3182f6; margin-top:10px;">
                â‰ˆ {div_krw:,.0f}ì› <span style="font-size:0.9rem; font-weight:500; color:#adb5bd;">(ì„¸ì „)</span>
                <span style="margin:0 8px; color:#e0e0e0;">|</span>
                <span style="color:#2196f3;">{div_krw_net:,.0f}ì› <span style="font-size:0.8rem; font-weight:500; color:#888;">(ì„¸í›„)</span></span>
            </div>
        </div>

        <div class="metric-container">
            <div class="metric-box">
                <div class="m-title">ğŸ“Š ë¶„ë°°ìœ¨(Rate)</div>
                <div class="m-data" style="color:#3182f6;">{d['rate']}%</div>
            </div>
            <div class="metric-box">
                <div class="m-title">ğŸ¦ ì‹¤ì§ˆìˆ˜ìµ(SEC)</div>
                <div class="m-data">{d['sec']}%</div>
            </div>
            <div class="metric-box">
                <div class="m-title">â†©ï¸ ì›ê¸ˆë°˜í™˜(ROC)</div>
                <div class="m-data" style="color: {'#e92c2c' if d['roc'] > 0 else '#00bfa5'};">{d['roc']}%</div>
            </div>
        </div>

        <div style="text-align:right; font-size:0.8rem; color:#adb5bd; margin-top:16px;">
            í˜„ì¬ ì£¼ê°€ ${curr_p:.2f} ê¸°ì¤€
        </div>
    </div>
""")

# -----------------------------
# [UI] 3. ë©€í‹° íƒ­ ê¸°ëŠ¥ (6ê°œ í†µí•©)
# -----------------------------
st.write("")
tab1, tab2, tab3, tab4, tab5, tab6 = st.tabs([
    "ğŸ§® ë°°ë‹¹ê¸ˆ", "ğŸ’§ ë¬¼íƒ€ê¸°", "ğŸ§ª ìŠ¤íŠ¸ë ˆìŠ¤", "ğŸ“‰ ì›ê¸ˆíšŒìˆ˜", "ğŸ”¥ FIRE", "â›„ ìŠ¤ë…¸ìš°ë³¼"
])

# --- íƒ­1: ê³„ì‚°ê¸° ---
with tab1:
    col1, col2 = st.columns([1, 1.5])
    with col1:
        st.write("") 
        shares = st.number_input("ë³´ìœ  ìˆ˜ëŸ‰(ì£¼)", min_value=1, value=1000, step=10, key="shares_cal")
    with col2:
        total_krw_before = shares * div_krw
        total_krw_after = total_krw_before * (1 - tax_rate)
        render_html(f"""
            <div class="calc-box">
                <div class="result-row">
                    <span class="result-label">ì´ ë°°ë‹¹ê¸ˆ(ì„¸ì „)</span>
                    <span class="result-val">{total_krw_before:,.0f}ì›</span>
                </div>
                <div class="result-row">
                    <span class="result-label">ì„¸ê¸ˆ(15.4%)</span>
                    <span class="result-val" style="color:#e92c2c;">-{total_krw_before*tax_rate:,.0f}ì›</span>
                </div>
                <div style="border-top:1px dashed #c5cdd6; margin: 12px 0;"></div>
                <div class="result-row">
                    <span class="result-label" style="font-weight:700; color:#3182f6;">ì‹¤ì œ ì…ê¸ˆì•¡</span>
                    <span class="result-total">{total_krw_after:,.0f}ì›</span>
                </div>
            </div>
            <div class="caution-box">
                <span class="caution-title">ğŸ“Œ ê³„ì‚° ê¸°ì¤€</span>
                â€¢ í™˜ìœ¨: <b>{usd_krw:,.2f}ì›</b> (ì‹¤ì‹œê°„) / ì„¸ìœ¨: <b>15.4%</b> (ë°°ë‹¹ì†Œë“ì„¸)<br>
                â€¢ ì´ë²ˆ ì£¼ ë°°ë‹¹ê¸ˆ <b>${d['div']:.4f}</b> ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤.
            </div>
        """)

# --- íƒ­2: ë¬¼íƒ€ê¸° ê³„ì‚°ê¸° ---
with tab2:
    col_m1, col_m2 = st.columns(2)
    with col_m1:
        my_avg = st.number_input("ë‚´ í‰ë‹¨ê°€ ($)", min_value=0.1, value=curr_p*1.1, step=0.1, format="%.2f")
    with col_m2:
        my_qty = st.number_input("í˜„ì¬ ë³´ìœ  ìˆ˜ëŸ‰", min_value=1, value=100, step=10)
    add_qty = st.number_input("ì¶”ê°€ ë§¤ìˆ˜ ìˆ˜ëŸ‰ (ì£¼)", min_value=1, value=50, step=10)

    total_cost_old = my_avg * my_qty
    total_cost_new = total_cost_old + (curr_p * add_qty)
    total_qty_new = my_qty + add_qty
    new_avg = total_cost_new / total_qty_new

    monthly_div = d['div'] 
    if monthly_div > 0:
        old_weeks = my_avg / monthly_div
        new_weeks = new_avg / monthly_div
        saved_weeks = old_weeks - new_weeks
    else:
        old_weeks = 0
        new_weeks = 0
        saved_weeks = 0

    render_html(f"""
        <div class="mul-card">
            <div style="font-size:0.9rem; color:#666; margin-bottom:8px;">í‰ë‹¨ê°€ ë³€í™”</div>
            <div style="font-size:1.4rem; font-weight:700; color:#333; display:flex; align-items:center;">
                ${my_avg:.2f} <span class="mul-arrow">â”</span> <span class="mul-highlight">${new_avg:.2f}</span>
            </div>
            <div style="margin-top:15px; padding:12px; background:#e3f2fd; border-radius:12px;">
                <div style="font-size:0.9rem; color:#1565c0;">ğŸš€ íƒˆì¶œ(ì›ê¸ˆíšŒìˆ˜) ê¸°ê°„ ë‹¨ì¶• íš¨ê³¼</div>
                <div style="font-size:1.1rem; font-weight:700; color:#0d47a1; margin-top:4px;">
                    {old_weeks:.1f}ì£¼ â” {new_weeks:.1f}ì£¼ <span style="color:#2e7d32;">(-{saved_weeks:.1f}ì£¼ ë‹¨ì¶•!)</span>
                </div>
            </div>
        </div>
        <div class="caution-box">
            <span class="caution-title">ğŸ“Œ ê³„ì‚° ê¸°ì¤€</span>
            â€¢ ì¶”ê°€ ë§¤ìˆ˜ëŠ” <b>í˜„ì¬ê°€ ${curr_p:.2f}</b>ì— ì²´ê²°ëœë‹¤ê³  ê°€ì •í–ˆìŠµë‹ˆë‹¤.<br>
            â€¢ ë°°ë‹¹ê¸ˆ <b>${monthly_div:.4f}</b>ê°€ ìœ ì§€ë  ê²½ìš°ì˜ ë‹¨ìˆœ ì‹œë®¬ë ˆì´ì…˜ì…ë‹ˆë‹¤.
        </div>
    """)

# --- íƒ­3: ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸ ---
with tab3:
    stress_shares = st.number_input("ë‚´ ë³´ìœ  ìˆ˜ëŸ‰", min_value=1, value=1000, step=10, key="stress_shares")
    base_div = d['div'] * usd_krw * (1 - tax_rate) # ì„¸í›„
    current_pay = stress_shares * base_div
    cut_10 = current_pay * 0.9
    cut_30 = current_pay * 0.7
    cut_50 = current_pay * 0.5

    render_html(f"""
        <div class="stress-card">
            <div class="stress-row" style="background:#f9f9f9; border-radius:8px; padding:10px;">
                <span class="stress-label">âš¡ í˜„ì¬ ìœ ì§€ ì‹œ</span>
                <span class="stress-val" style="color:#3182f6;">{current_pay:,.0f}ì›</span>
            </div>
            <div class="stress-row">
                <span class="stress-label"><span class="stress-badge">ğŸ“‰ -10% ì‚­ê°</span></span>
                <span class="stress-val">{cut_10:,.0f}ì›</span>
            </div>
            <div class="stress-row">
                <span class="stress-label"><span class="stress-badge">ğŸ“‰ -30% ì‚­ê°</span></span>
                <span class="stress-val">{cut_30:,.0f}ì›</span>
            </div>
            <div class="stress-row">
                <span class="stress-label"><span class="stress-badge" style="background:#ffebee; color:#c62828;">ğŸ“‰ -50% ì‚­ê°</span></span>
                <span class="stress-val" style="color:#c62828;">{cut_50:,.0f}ì›</span>
            </div>
        </div>
        <div class="caution-box">
            <span class="caution-title">ğŸ“Œ ê³„ì‚° ê¸°ì¤€</span>
            â€¢ <b>ì„¸í›„(15.4% ê³µì œ)</b> ê¸ˆì•¡ ê¸°ì¤€ì…ë‹ˆë‹¤.<br>
            â€¢ ì‹¤ì œ ì§€ê¸‰ì•¡ì€ í™˜ìœ¨ ë° ë°°ë‹¹ê¸ˆ ë³€ë™ì— ë”°ë¼ ì°¨ì´ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>
    """)

# --- íƒ­4: BEP ---
with tab4:
    my_price = st.number_input(f"ë‚´ í‰ë‹¨ê°€ ($)", min_value=0.1, value=curr_p, step=0.1, format="%.2f", key="bep_price")
    monthly_div = d['div'] 

    if monthly_div > 0:
        weeks_needed = my_price / monthly_div
        months_needed = weeks_needed / 4.3
        render_html(f"""
            <div class="bep-card">
                <div style="color:#555; font-size:0.9rem; margin-bottom:8px;">ì›ê¸ˆ íšŒìˆ˜(Free Ride)ê¹Œì§€</div>
                <div style="font-size:2rem; font-weight:900; color:#e92c2c; margin-bottom:8px;">
                    {weeks_needed:.1f}ì£¼ <span style="font-size:1rem; color:#888; font-weight:500;">(ì•½ {months_needed:.1f}ê°œì›”)</span>
                </div>
                <div style="background:#fff0f2; padding:10px; border-radius:12px; font-size:0.85rem; color:#d63031;">
                    ğŸ’¡ <b>{weeks_needed:.0f}ë²ˆ</b>ë§Œ ë°°ë‹¹ì„ ë” ë°›ìœ¼ë©´ ì›ê¸ˆ íšŒìˆ˜ ì™„ë£Œ!
                </div>
            </div>
            <div class="caution-box">
                <span class="caution-title">ğŸ“Œ ê³„ì‚° ê¸°ì¤€</span>
                â€¢ í˜„ì¬ {sel_ticker} ë°°ë‹¹ê¸ˆ <b>${monthly_div:.4f}</b> ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
                â€¢ <b>"ë‹¤ìŒ ì£¼ì—ë„ ë°°ë‹¹ê¸ˆì´ ë˜‘ê°™ì´ ë‚˜ì˜¨ë‹¤ë©´"</b>ì„ ê°€ì •í•œ ê²°ê³¼ì…ë‹ˆë‹¤.
            </div>
        """)

# --- íƒ­5: ì£¼ê°„ FIRE ---
with tab5:
    weekly_div_net = div_krw * (1 - tax_rate)
    target_money = st.number_input("ëª©í‘œ 'ì£¼ê°„' ë°°ë‹¹ê¸ˆ (ë§Œì›)", min_value=10, value=50, step=10, key="fire_target")
    target_krw = target_money * 10000

    if weekly_div_net > 0:
        needed_shares = math.ceil(target_krw / weekly_div_net)
        needed_capital = needed_shares * curr_p * usd_krw
    else:
        needed_shares = 0
        needed_capital = 0

    render_html(f"""
        <div class="fire-card">
            <div style="font-size:1.1rem; font-weight:700; color:#191f28; margin-bottom:15px;">
                ë§¤ì£¼ <span style="color:#3182f6; font-size:1.4rem;">{target_money:,}ë§Œì›</span> ë°›ê¸°
            </div>
            <div style="display:flex; justify-content:center; align-items:center; gap:20px; margin-top:20px;">
                <div>
                    <div style="font-size:0.85rem; color:#888; margin-bottom:4px;">í•„ìš” ì£¼ì‹ ìˆ˜</div>
                    <div style="font-size:1.4rem; font-weight:900; color:#333;">{needed_shares:,}ì£¼</div>
                </div>
                <div style="width:1px; height:40px; background:#e5e8eb;"></div>
                <div>
                    <div style="font-size:0.85rem; color:#888; margin-bottom:4px;">ì˜ˆìƒ íˆ¬ìê¸ˆ</div>
                    <div style="font-size:1.4rem; font-weight:900; color:#3182f6;">{needed_capital/10000:,.0f}ë§Œì›</div>
                </div>
            </div>
        </div>
        <div class="caution-box">
            <span class="caution-title">ğŸ“Œ ê³„ì‚° ê¸°ì¤€</span>
            â€¢ í™˜ìœ¨: <b>{usd_krw:,.2f}ì›</b> / í˜„ì¬ ì£¼ê°€: <b>${curr_p:.2f}</b><br>
            â€¢ ì´ë²ˆ ì£¼ ë°°ë‹¹ê¸ˆ <b>${d['div']:.4f}</b>ê°€ ë§¤ì£¼ ì§€ì†ëœë‹¤ê³  ê°€ì •í•œ ê²°ê³¼ì…ë‹ˆë‹¤.
        </div>
    """)

# --- íƒ­6: ìŠ¤ë…¸ìš°ë³¼ (í†µí•©ë¨) ---
with tab6:
    my_shares = st.number_input("í˜„ì¬ ë³´ìœ  ì£¼ì‹ ìˆ˜", min_value=1, value=1000, step=10, key="snow_shares_tab")
    weekly_div_net = div_krw * (1 - tax_rate)
    current_weekly_pay = my_shares * weekly_div_net
    share_price_krw = curr_p * usd_krw

    if share_price_krw > 0:
        reinvest_shares = math.floor(current_weekly_pay / share_price_krw)
        leftover_cash = current_weekly_pay - (reinvest_shares * share_price_krw)
        next_week_increase = reinvest_shares * weekly_div_net

        render_html(f"""
            <div class="snow-card">
                <div style="margin-bottom:15px;">
                    <span style="font-size:0.9rem; color:#555;">ì´ë²ˆ ì£¼ ë°°ë‹¹ê¸ˆìœ¼ë¡œ</span><br>
                    <span style="font-size:1.6rem; font-weight:900; color:#2196f3;">+{reinvest_shares}ì£¼</span>
                    <span style="font-size:1.1rem; font-weight:700; color:#333;"> ì¶”ê°€ ë§¤ìˆ˜ ê°€ëŠ¥!</span>
                </div>
                <div style="background:white; border-radius:12px; padding:15px; border:1px solid #e3f2fd;">
                    <div style="font-size:0.9rem; color:#888;">ê·¸ëŸ¼ ë‹¤ìŒ ì£¼ ë‚´ ë°°ë‹¹ê¸ˆì€?</div>
                    <div style="font-size:1.3rem; font-weight:800; color:#191f28; margin-top:4px;">
                        {current_weekly_pay:,.0f}ì› <span style="color:#2196f3;">(+{next_week_increase:,.0f}ì›)</span>
                    </div>
                </div>
            </div>
            <div class="caution-box">
                <span class="caution-title">ğŸ“Œ ê³„ì‚° ê¸°ì¤€</span>
                â€¢ ì¬íˆ¬ì ì£¼ê°€: <b>${curr_p:.2f}</b> / ë°°ë‹¹ê¸ˆ ìœ ì§€ ê°€ì •<br>
                â€¢ ë‚¨ëŠ” ì°¨ì•¡ {leftover_cash:,.0f}ì›ì€ ì œì™¸í•˜ê³  ê³„ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤.
            </div>
        """)

# -----------------------------
# [UI] 5. ìš©ì–´ ì„¤ëª…
# -----------------------------
st.write("")
with st.expander("ğŸ“ ì£¼ë¦°ì´ë¥¼ ìœ„í•œ ìš©ì–´ ê°€ì´ë“œ"):
    render_html("""
    <div style="background:#f2f4f6; padding:16px; border-radius:12px; font-size:0.9rem; line-height:1.6; color:#4e5968;">
        <div style="margin-bottom:12px;">
            <strong style="color:#191f28;">1ï¸âƒ£ Distribution Rate (ë¶„ë°°ìœ¨)</strong><br>
            ì´ë²ˆ ë°°ë‹¹ê¸ˆì„ 1ë…„ ë‚´ë‚´ ë˜‘ê°™ì´ ì¤€ë‹¤ê³  ê°€ì •í–ˆì„ ë•Œì˜ ë‹¨ìˆœ ì—° ìˆ˜ìµë¥ ì…ë‹ˆë‹¤.
        </div>
        <div style="margin-bottom:12px;">
            <strong style="color:#191f28;">2ï¸âƒ£ 30-Day SEC Yield (ì‹¤ì§ˆ ìˆ˜ìµë¥ )</strong><br>
            ìµœê·¼ 30ì¼ê°„ í€ë“œê°€ <b>ì‹¤ì œë¡œ ë²ˆ ì´ì ìˆ˜ìµ</b>ì…ë‹ˆë‹¤. ì´ ìˆ˜ì¹˜ê°€ ë†’ì„ìˆ˜ë¡ í€ë“œ ìì²´ê°€ ëˆì„ ì˜ ë²Œê³  ìˆë‹¤ëŠ” ëœ»ì…ë‹ˆë‹¤.
        </div>
        <div>
            <strong style="color:#191f28;">3ï¸âƒ£ ROC (Return of Capital, ì›ê¸ˆ ë°˜í™˜)</strong><br>
            <span style="color:#e92c2c;">âš ï¸ ì£¼ì˜!</span> í€ë“œê°€ ë²ˆ ëˆì´ ì•„ë‹ˆë¼, <b>ë‚´ ì›ê¸ˆì„ ê¹ì•„ì„œ ë°°ë‹¹ìœ¼ë¡œ ëŒë ¤ì£¼ëŠ” ë¹„ìœ¨</b>ì…ë‹ˆë‹¤.
        </div>
    </div>
    """)